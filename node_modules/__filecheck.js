var CONFIG = require("config");
var fs = require("fs");
var path = require("path");
var jf = require('jsonfile');
var util = require('util');
//var url = require('url');
var slash = require('slash');


jf.spaces = '\t';


var FileManager = require("FileManager");
var vidArray = FileManager.getFilesArray("./mp4", ["**.m4v"]);

var model = FileManager.getFilesObject(vidArray),
    ffmpeg = require("fluent-ffmpeg"),
    lastVideo = model.length - 1,
    currentVideo = 0,
    data,
    metaArray = [];


function storeData(obj) {
    metaArray.push(obj);
}

function finished() {
    fs.writeFileSync("./datanew.json", JSON.stringify(metaArray, {}, "\t"), {encoding: 'utf-8'});
}

function loop(fin) {
    var workingArray = Array();

    if (currentVideo <= lastVideo) {
        var genThumb = false;
        console.log("Processing: " + model[currentVideo].path);

        //Get Video MetaData using ffmpeg
        ffmpeg.ffprobe(model[currentVideo].path, function (err, metadata) {
            if (err) throw err;
            console.log(metadata);
            var vidName = path.basename(metadata.format.filename, path.extname(metadata.format.filename));
            var vidFilename = path.basename(metadata.format.filename);
            var vidPath = path.relative(process.cwd(), metadata.format.filename);
            var vidDuration = metadata.streams[0].duration;
            var vidFormat = metadata.streams[0].codec_name;
            var thumbFolder = path.relative(process.cwd(), path.normalize(path.dirname(metadata.format.filename) + "\\thumbs\\" + vidName + "-thumb.png"));

            console.log(vidFilename + ": " + vidDuration);
            if (!fs.existsSync(path.dirname(thumbFolder))) fs.mkdirSync(path.dirname(thumbFolder));

            if (!fs.existsSync(thumbFolder)) {
                genThumb = true;
            }

            var meta = {
                name: vidName,
                filename: vidFilename,
                path: vidPath,
                duration: vidDuration,
                format: vidFormat,
                width: metadata.streams[0].width,
                height: metadata.streams[0].height,
                thumb: thumbFolder,
                categories: [],
                tags: []
            };

            if (genThumb) {


                ffmpeg(vidPath).screenshots({
                    timestamps: ["50%"],
                    filename: path.basename(thumbFolder),
                    folder: path.dirname(thumbFolder),
                    size: "160x120"
                });

            }

            storeData(meta);
            currentVideo++;
            loop(fin);

        });
    } else {
        fin();
    }


}


loop(finished);


//if(fs.existsSync(CONFIG.compicsDataFile)) {
//
//} else {
//    console.log("Compic Metadata file not found, creating...");
//
//    var filesys = require("filesystem");
//    var compicFiles = filesys.getFilesArray(CONFIG.folders.compicsRoot, CONFIG.extensions.compics);
//
//    for(pic in compicFiles) {
//
//    }
//
//}